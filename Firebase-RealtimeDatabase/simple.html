<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª</title>

    <!-- <style>
        #output {
            height: 300px;
            overflow: scroll;
        }
    </style> -->
    <link rel="stylesheet" href="/style.css">

</head>
<body>
<!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <section>
        <p>ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã§ã™ã€‚</p>
        <input type="button" value="ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ" id="logoutBtn">
    </section>
        

<!-- ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚¿ã‚¤ãƒˆãƒ« -->
    <div class="line__title">
        ãã‚‡ã¤ã®ã²ã¨ã‚Šéƒ¨å±‹
    </div>
<!-- ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚¿ã‚¤ãƒˆãƒ« -->
        <div id="output"  class="line__contents scroll" style="overflow: auto;height: 500px;"></div>

<!-- é€ä¿¡ç”»é¢ -->

<div>
    <!-- <div> åå‰ï¼š<input type="text" id="uname"> </div> -->
    <div class="message-area">
        <textarea id="text" cols="50" rows="10"></textarea>
        <button id="send">é€ä¿¡</button>
        
    </div>
    
    <!--/ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->



<!-- JQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<!-- JQuery -->


<!--** ä»¥ä¸‹Firebase ï¼ˆfirebaceã‹ã‚‰ã‚³ãƒ”ãƒ¼ 29~47è¡Œï¼‰**-->
<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
    // è²¼ã‚Šä»˜ã‘ã‚‹å ´æ‰€â†“
    import { getDatabase, ref, push, set, onChildAdded, remove,onChildRemoved,serverTimestamp} from "https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged} from "https://www.gstatic.com/firebasejs/9.1.0/firebase-auth.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDzTZz0FUL6msWdQ_KXbdkWp78VucCVl60",
      authDomain: "dev245-9dcb8.firebaseapp.com",
      projectId: "dev245-9dcb8",
      storageBucket: "dev245-9dcb8.appspot.com",
      messagingSenderId: "397119300991",
      appId: "1:397119300991:web:5f11a83dc3d7986d6ba64a"
    };

    
  
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);

    // ã“ã®è¾ºã‚Šã«æ›¸ã„ã¦ã„ãã¾ã™
    // â†“firebaseã®ãŠã¾ã˜ãªã„
    const db = getDatabase(app);//Realtimefirebaseã«æ¥ç¶š
    const dbRef = ref(db, 'dev245');
    //æ™‚é–“å–å¾—
    const timestamp = serverTimestamp();
    

    // é€ä¿¡å‡¦ç†ã‚’è¨˜è¿°
    $('#send').on('click',function(){
        // id="uname"ã®å ´æ‰€ã‚’å–å¾—ã—ã¾ã™
        const uname = $('#uname').val();
        // id="text"ã®å ´æ‰€ã‚’å–å¾—ã—ã¾ã™
        const text = $('#text').val();
       
        // å–å¾—ã§ãã¦ã‚‹ã‹è¡¨ç¤ºã®ç¢ºèªï¼å¿…é ˆï¼
        // alert(uname + text);

        // ãƒ‡ãƒ¼ã‚¿ã®å¡Šã‚’ä½œã‚Šã¾ã™ğŸ¤—
        // msg ã¨ã„ã†åå‰ã§å¡Šã‚’ä½œã‚Šã¾ã™
        // unameã¨ã„ã†éµã®åå‰
        // textã¨ã„ã†ã‚«ã‚®ã®åå‰
        // ä½œæˆã—ãŸãƒ‡ãƒ¼ã‚¿ã®å¡Šã‚’firebaseã«é€ä¿¡ã‚’ã—ã¾ã™â‡¨ã¤ã¾ã‚Šã“ã‚ŒãŒä¿å­˜ã«ãªã‚Šã¾ã™ğŸ¤—
        const msg = {
            uname: "ãã‚‡ã¤",
            text: text,
            timestamp: timestamp,
        }
        // firebaseã«é€ã‚‹æº–å‚™ã‚’ã—ã¦ã„ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ğŸ¤—
        const newPostRef = push(dbRef) //ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã§ãã‚‹æº–å‚™(refã¯å‚ç…§ã™ã‚‹ã®æ„å‘³)
        set(newPostRef, msg); // firebaseã®ç™»éŒ²ã§ãã‚‹å ´æ‰€ã«ä¿å­˜ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ğŸ¤—

         // å—ä¿¡å‡¦ç†ã‚’è¨˜è¿°



            // é€ä¿¡å¾Œã«ã€å…¥åŠ›æ¬„ã‚’ç©ºã«ã—ã¾ã—ã‚‡ã†ğŸ¤—(ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã¡ã‚‡ã£ã¨å¬‰ã—ã„)
            $('#uname').val("");
            $('#text').val("");

            // ã“ã‚Œã‚’ä½¿ã†ã¨ã©ã†ãªã‚‹ã‹ã¿ã¦ã¿ã¾ã—ã‚‡ã†ğŸ¤—(ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã¡ã‚‡ã£ã¨å¬‰ã—ã„)
            $("#uname").focus();
    
        // sendé€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ ã“ã®ä¸‹æ¶ˆã•ãªã„
    });

    onChildAdded(dbRef, function (data) {
            // ã“ã“ã‹ã‚‰ãŒå—ä¿¡å‡¦ç†ãŒå§‹ã¾ã‚Šã¾ã™

            // ç™»éŒ²ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ğŸ¤—
            const msg = data.val();
            console.log(msg, 'å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã®å¡Š')
            const key = data.key;
            console.log(key, 'ãƒ‡ãƒ¼ã‚¿ã®å¡Šã«ã‚¢ã‚¯ã‚»ã‚¹')

            let now = msg.timestamp;//ãªãœä¸€åº¦nowã«å…¥ã‚Œãªã„ã¨ã„ã‘ãªã„ï¼Ÿã—ã‚“ã¾ã‚ã•ã‚“ã«èãï¼
            let date = new Date(now); //å·®åˆ†ã®ãƒŸãƒªç§’ã‚’newDateã«å…¥ã‚Œã‚‹ï¼èª¿ã¹ã‚‹ï¼ä¸€æ—¦å…¥ã‚Œã‚‹ã€‚ä¸‹æº–å‚™
            //å·®åˆ†ã®ãƒŸãƒªç§’ã‹ã‚‰æ™‚åˆ»ã‚’å‰²ã‚Šæˆ»ã™
            let dates = date.getFullYear() + "å¹´" + (date.getMonth() +1) + "æœˆ" + date.getDate() + "æ—¥ " + date.getHours() + "æ™‚" + date.getMinutes() + "åˆ†"
            console.log(dates);
            // es6ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒ†ãƒ©ãƒ«
            let h =/* HTML */`
            <div class="balloon">
                <div class="faceicon"><img src="img/paa.jpeg" alt="" ></div>
               <div>
                    <p class="says_name">${msg.uname}</P>
                    <p class="says">${msg.text}</P>
                    <!-- <button id="update">æ›´æ–°</button> -->
                    <p>${dates}</p>
                    <button id="deleteKey" name="${key}">å‰Šé™¤</button>
                </div>
            </div>
            `;

            $("#output").append(h);
        
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¸€ç•ªä¸‹ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«
            const output = document.getElementById('output');
            output.scrollTo(0, output.scrollHeight);

        });

        //#############################################
        // ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ï¼ˆå€‹åˆ¥ã‚³ãƒ¡ãƒ³ãƒˆï¼‰
        //#############################################
        // #deleteã‚’æŠ¼ã—ãŸã‚‰dbã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ï¼
        $(document).on("click", "#deleteKey", function () {;
        // buttonã®nameã‚’å–å¾—ã—ã¦dbã®ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã‚’å‰Šé™¤ã—ã¾ã™ã€‚
        let target = $(this).attr("name");
        console.log(target);
        remove(ref(db, "dev245/" + target));

        // ç”»é¢ã‚’æ›´æ–°ã—ã¦åæ˜ ã•ã›ã¾ã™ã€‚
        location.reload();

        });

        //#############################################
        // ãƒ‡ãƒ¼ã‚¿æ›´æ–°ï¼ˆå€‹åˆ¥ã‚³ãƒ¡ãƒ³ãƒˆï¼‰â€»ä»Šå›å®Ÿè£…ã§ããš
        //#############################################

        // $(document).on("click", "#update", function () {
        // // buttonã®nameã‚’å–å¾—ã—ã¦dbã®ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã‚’ã—ã¾ã™ã€‚
        // const update= $(this).attr("name");//ãã®ã‚³ãƒ¡ãƒ³ãƒˆã®Keyã‚’æŒ‡å®š
        // console.log(update),"æ›´æ–°ã—ãŸãƒ‡ãƒ¼ã‚¿";
        // update(ref(db, "dev245/" + update));//ãªã‚“ã§ï¼‹ã‚’ä½¿ã†ã®ã‹ä¸æ˜


        // const updateName = (uname, text) => {
        //     db.ref("dev245/" + text).update({
        //         text: text,
        //         timestamp: timestamp,

        //     });
        // };


         // å—ä¿¡å‡¦ç†ã‚’è¨˜è¿°



        //     // é€ä¿¡å¾Œã«ã€å…¥åŠ›æ¬„ã‚’ç©ºã«ã—ã¾ã—ã‚‡ã†ğŸ¤—(ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã¡ã‚‡ã£ã¨å¬‰ã—ã„)
        //     $('#uname').val("");
        //     $('#text').val("");

        //     // ã“ã‚Œã‚’ä½¿ã†ã¨ã©ã†ãªã‚‹ã‹ã¿ã¦ã¿ã¾ã—ã‚‡ã†ğŸ¤—(ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã¡ã‚‡ã£ã¨å¬‰ã—ã„)
        //     $("#uname").focus();

        // // ç”»é¢ã‚’æ›´æ–°ã—ã¦åæ˜ ã•ã›ã¾ã™ã€‚
        // location.reload();

        // });


        //#############################################
        // GoogleAuthç”¨
        //#############################################
        const provider = new GoogleAuthProvider();
        provider.addScope('https://www.googleapis.com/auth/contacts.readonly')
        const auth = getAuth();
        
        //#############################################
        // loginã—ã¦ã„ã‚Œã°å‡¦ç†ã—ã¾ã™
        //#############################################
        onAuthStateChanged(auth,(user) => {
            if(user){
                const uid = user.uid;
                //ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨æƒ…å ±å–å¾—ã§ãã¾ã™
                if(user !== null) {
                    user.providerDate.forEach((profile)=>{

                        $("#uname").text(profile.displayName);
                        $("prof").attr("scr",profile.photoURL);
                    });
                    $("#status").fadeOut(500);
                }
            }


        })

        //###############################################
        //Logoutå‡¦ç†
        //###############################################
        $("#logoutBtn").on("click", function () {
            // signInWithRedirect(auth, provider);
            signOut(auth).then(() => {
                // Sign-out successful.
                _redirect();
            }).catch((error) => {
                // An error happened.
                console.error(error);
            });
        });


        //###############################################
        //Loginç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ(é–¢æ•°ä½œæˆ)
        //###############################################
        function _redirect(){
            location.href="login.html";
        }


       

 </script>





</body>
</html>
































